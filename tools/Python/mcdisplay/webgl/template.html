<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<style>
		body { margin: 0; }
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>
	<script src="https://sim.e-neutrons.org/static/threejs/three.min.js"></script>
	<script src="https://sim.e-neutrons.org/static/threejs/dat.gui.min.js"></script>
	<script src="https://sim.e-neutrons.org/static/threejs/OrbitControls.js"></script>
	<script src="https://sim.e-neutrons.org/static/threejs/Lut.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
	<script src="_mcdisplay.js"></script>
	<script src="_instr.js"></script>
	<script src="_neutrons.js"></script>

	<script>
		var campos_x = -26.3, campos_y = 26.3, campos_z = 26.3;
		// INSERT_CAMPOS_HERE: x = XVAL, y = YVAL, z = ZVAL;
		var controller = new Controller(campos_x, campos_y, campos_z);
		var viewmodel = controller.viewmodel;

		// UI event handlers interacting only(!!) with the viewmodel.
		// TODO: implement callbacks
		var handlePlayPause = function()
		{
			if (viewmodel.playBack == PlayBack.RUN)
			{
				viewmodel.setPlayBack(PlayBack.PAUSE);
			}
			else
			{
				viewmodel.setPlayBack(PlayBack.RUN);
			}
		}
		var handleNext = function()
		{
			viewmodel.setPlayBack(PlayBack.PAUSE);
			viewmodel.setRayIdx(viewmodel.getRayIdx() + 1);
		}
		var handlePrev = function()
		{
			viewmodel.setPlayBack(PlayBack.PAUSE);
			viewmodel.setRayIdx(viewmodel.getRayIdx() - 1);
		}
		var handleKeepChanged = function(checked)
		{
			if (checked)
			{
				viewmodel.setDisplayMode(DisplayMode.KEEP);
			}
			else
			{
				viewmodel.setDisplayMode(DisplayMode.SINGLE);
			}
		}
		var handleViewTop = function()
		{
			controller.setViewTop();
		}
		var handleViewSide = function()
		{
			controller.setViewSide();
		}
		var handleViewHome = function()
		{
			controller.setViewHome();
		}
	</script>

	<div id="gui" style="width: auto; background-color: black;">
		<label id="lblInstrInfo" style="color: white;">(instr)</label>
	</div>
	<div id="gui" style="width: auto; background-color: black;">
		<label id="lblKeep" style="color: white; background-color: black; display: inline-block; text-align:right;">
			Keep rays<input id="cbxKeep" type="checkbox">
		</label>
		<button id="btnPrev", onclick="handlePrev();" style="width: 90px;">Previous</button>
		<button id="btnPlayPause", onclick="handlePlayPause();" style="width: 90px;">Play/Pause</button>
		<button id="btnNext", onclick="handleNext();" style="width: 90px;">Next</button>
		<label id="lblRayIdxText" style="color: white;">Ray index</label>
		<label id="lblRayIdx" style="color: white; background-color: black; width: 27px; text-align: right; display: inline-block;">(idx)</label>
		<label id="lblMaxRayIdx" style="color: white; background-color: black; display: inline-block;">(max_idx)</label>
		<label id="lblView" style="color: white; background-color: black; display: inline-block; text-align:right; width: 150px;">Reset view</label>
		<!--<button id="btnTop", onclick="handleViewTop();" style="width: 60px;">Top</button>
		<button id="btnSide", onclick="handleViewSide();" style="width: 60px;">Side</button>-->
		<button id="btnHome", onclick="handleViewHome();" style="width: 60px;">Home</button>
	</div>
	<div id="3dcanvas"></div>

	<script>
		// gui synchronization class
		//
		var UpdateGui = function()
		{
			this.vm_version = -1;
			this.viewmodel = viewmodel;
		}
		UpdateGui.prototype.update = function()
		{
			// return if viewmodel is constant
			if (this.vm_version == this.viewmodel.getUpdateVersion()) { return; }

			this.vm_version = this.viewmodel.getUpdateVersion();

			// update playback mode
			var pb = this.viewmodel.getPlayBack();
			if (pb == PlayBack.RUN)
			{
				btn = document.getElementById("btnPlayPause");
				btn.innerHTML = "Pause";
			}
			if (pb == PlayBack.PAUSE)
			{
				btn = document.getElementById("btnPlayPause");
				btn.innerHTML = "Play";
			}
			// update ray index
			lbl = document.getElementById("lblRayIdx");
			lbl.innerHTML = this.viewmodel.getRayIdx();

			// update keep ckeckbox
			cbxKeep = document.getElementById("cbxKeep");
			var dm = this.viewmodel.getDisplayMode();
			if (dm == DisplayMode.SINGLE)
			{
				cbxKeep.checked = false;
			}
			else
			{
				cbxKeep.checked = true;
			}
		}
		var upd = new UpdateGui();

		// set up static ui
		lblInstrInfo = document.getElementById("lblInstrInfo");
		lblInstrInfo.innerHTML = MCDATA_instrdata["cmd"];
		lblMaxRayIdx = document.getElementById("lblMaxRayIdx");
		lblMaxRayIdx.innerHTML = '/ ' + (MCDATA_neutrondata["numrays"] - 1);

		// set keep checkbox event handler
		cbxKeep = document.getElementById("cbxKeep");
		cbxKeep.addEventListener("change", function () { handleKeepChanged(cbxKeep.checked) });

		// call the mcdisplay app!
		controller.setUpdateGuiFunc(upd.update);
		controller.run();
    </script>
</body>
</html>
