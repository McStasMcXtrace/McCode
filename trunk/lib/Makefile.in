# Makefile for McStas.
#
#   This file is part of the McStas neutron ray-trace simulation package
#   Copyright (C) 1997-2008, All rights reserved
#   Risoe National Laborartory, Roskilde, Denmark
#   Institut Laue Langevin, Grenoble, France
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; version 2 of the License.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# Available methods for installation
# make                 normal build
# make install         normal installation
# make install-pgplot  build and install PGPLOT
# make clean           clean distro
# make test            distro self-test
# make plotter         best plotter choice
# make reconfigure     reconfigure mcstas installation (after software update)


SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
srcdir = @srcdir@
topdir = ..
libdir = @libdir@
mandir = @mandir@
PWD = `pwd`


DEBUG = -DDEBUG=0
mc_libdir = $(libdir)/mcstas
mx_libdir = $(libdir)/mcxtrace

CC = @CC@
MINGW = @MINGW@
CFLAGS = @CFLAGS@
LDFLAGS= @LDFLAGS@

HAVE_QSORT = @HAVE_QSORT@
USE_NEXUS = @HAVE_NEXUS@

DEFS = @DEFS@ $(DEBUG)
LIBS = @LIBS@

PERL = @PERL@

FLEX = flex
FLEXFLAGS=-i

BISON = bison
BISONFLAGS = -v -d

SCILAB = @SCILAB@
MATLAB = @MATLAB@
PGPLOT = @PGPLOT@
VRML = @VRMLVIEW@

WGET = @WGET@

XTERM = @TERM@

INSTALL=@INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@


#
# End of configuration section.
#

OBJECTS=instrument.tab.o lex.yy.o debug.o \
	memory.o list.o symtab.o coords.o cexp.o \
	file.o cogen.o port.o
COBJECTS=instrument.tab.c lex.yy.c debug.c \
	memory.c list.c symtab.c coords.c cexp.c \
	file.c cogen.c port.c

PERLOBJ=mcdisplay.fixpl mcplot.fixpl mcresplot.fixpl mcrun.fixpl \
        mcgui.fixpl mcdoc.fixpl mcstas2vitess.fixpl mcconvert.fixpl mcdaemon.fixpl mcformatgui.fixpl
PERLBIN=mcdisplay mcplot mcresplot mcrun mcgui mcdoc mcstas2vitess mcconvert mcdaemon mcformatgui
BINOBJS=$(PERLOBJ) mcstas mcformat

.SUFFIXES: .c .o .pl .fixpl

.c.o:
	$(CC) -I. -I$(srcdir) -c $(CFLAGS) -DMCSTAS='"'$(mc_libdir)'"' $(DEFS) $<

.pl.fixpl:
	sed -e 's+#! /usr/bin/perl+#! '$(PERL)'+' \
	    -e 's+\$MCSTAS::sys_dir = "/usr/local/lib/mcstas"+\$MCSTAS::sys_dir = "'$(mc_libdir)'"+' \
	    < $< > $@
	chmod +x $@


all: $(BINOBJS)

mcstas: $(OBJECTS)
	$(CC) -o mcstas $(CFLAGS) $(LDFLAGS) $(DEFS) $(OBJECTS) -lm

mcstas.win32: $(COBJECTS)
	$(MINGW) -o mcstas.exe -DMCSTAS='"C:\\McStas\\lib"' $(CFLAGS) $(LDFLAGS) $(DEFS) $(COBJECTS) -lm $(USE_NEXUS)
	$(MINGW) -o mcformat.exe -DMCSTAS='"C:\\McStas\\lib"' $(CFLAGS) $(LDFLAGS) $(DEFS) mcformat.c -lm $(USE_NEXUS)


mcformat:
	$(CC) -o mcformat $(CFLAGS) $(LDFLAGS) $(DEFS) mcformat.c -lm $(LIBS) $(USE_NEXUS)

clean:
	rm -f $(BINOBJS) $(OBJECTS) $(PERLOBJ) TAGS \
	instrument.tab.c instrument.tab.h instrument.output lex.yy.c \
	config.cache Makefile
	rm -rf selftest_*/ selftest/

TAGS:
	etags *.[chly]

install: installdirs
	if [ -d $(mc_libdir) ]; then \
	  echo "Moving your old library dir $(mc_libdir) to $(mc_libdir).`date +%Y%m%d_%H.%M`"; \
	  mv -f $(mc_libdir) $(mc_libdir).`date +%Y%m%d_%H.%M`;\
        fi;
	$(topdir)/mkinstalldirs $(mc_libdir)

	cd $(topdir) && for file in `cd lib; ls | grep -v .svn| grep -v Make`; do \
	  if [ -d lib/$$file ]; then \
	    ./mkinstalldirs $(mc_libdir)/$$file; \
	    for comp in `cd lib/$$file; ls | grep -v .svn`; do \
        if [ -f $(mc_libdir)/$$file/$$comp ]; then \
          echo "Renaming old library element version $(mc_libdir)/$$file/$$comp to $(mc_libdir)/$$file/$$comp.old"; \
          mv -f $(mc_libdir)/$$file/$$comp $(mc_libdir)/$$file/$$comp.old; \
        fi; \
	      if [ -d lib/$$file/$$comp ]; then \
          ./mkinstalldirs $(mc_libdir)/$$file/$$comp; \
          for tool in `cd lib/$$file/$$comp; ls | grep -v .svn`; do \
	      if [ -d lib/$$file/$$comp/$$tool ]; then \
          ./mkinstalldirs $(mc_libdir)/$$file/$$comp/$$tool ; \
	        for subtool in `cd lib/$$file/$$comp/$$tool; ls | grep -v .svn`; do \
		  if [ -d lib/$$file/$$comp/$$tool/$$subtool ]; then \
		     ./mkinstalldirs $(mc_libdir)/$$file/$$comp/$$tool/$$subtool ; \
	             for subsubtool in `cd lib/$$file/$$comp/$$tool/$$subtool; ls | grep -v .svn`; do \
                       $(INSTALL_DATA) lib/$$file/$$comp/$$tool/$$subtool/$$subsubtool $(mc_libdir)/$$file/$$comp/$$tool/$$subtool/$$subsubtool; \
                     done \
		  else \
                    $(INSTALL_DATA) lib/$$file/$$comp/$$tool/$$subtool $(mc_libdir)/$$file/$$comp/$$tool/$$subtool; \
		  fi; \
                done \
              else \
                $(INSTALL_DATA) lib/$$file/$$comp/$$tool $(mc_libdir)/$$file/$$comp/$$tool; \
	      fi; \
          done \
        else \
	        $(INSTALL_DATA) lib/$$file/$$comp $(mc_libdir)/$$file/$$comp; \
        fi; \
	    done \
	  else \
	    $(INSTALL_DATA) lib/$$file $(mc_libdir)/$$file; \
	  fi \
	done
#	cd $(topdir)/nlib && $(MAKE) install

installdirs:
	$(topdir)/mkinstalldirs $(bindir) $(libdir) $(mc_libdir) $(mandir)/man1

mxinstall: mxinstalldirs
	if [ -d $(mx_libdir) ]; then \
	  echo "Moving your old library dir $(mx_libdir) to $(mx_libdir).`date +%Y%m%d_%H.%M`"; \
	  mv -f $(mx_libdir) $(mx_libdir).`date +%Y%m%d_%H.%M`;\
        fi;
	$(topdir)/mkinstalldirs $(mx_libdir)

	cd $(topdir) && for file in `cd lib; ls | grep -v .svn| grep -v Make`; do \
	  if [ -d lib/$$file ]; then \
	    ./mkinstalldirs $(mx_libdir)/$$file; \
	    for comp in `cd lib/$$file; ls | grep -v .svn`; do \
        if [ -f $(mx_libdir)/$$file/$$comp ]; then \
          echo "Renaming old library element version $(mx_libdir)/$$file/$$comp to $(mx_libdir)/$$file/$$comp.old"; \
          mv -f $(mx_libdir)/$$file/$$comp $(mx_libdir)/$$file/$$comp.old; \
        fi; \
	      if [ -d lib/$$file/$$comp ]; then \
          ./mkinstalldirs $(mx_libdir)/$$file/$$comp; \
          for tool in `cd lib/$$file/$$comp; ls | grep -v .svn`; do \
	      if [ -d lib/$$file/$$comp/$$tool ]; then \
          ./mkinstalldirs $(mx_libdir)/$$file/$$comp/$$tool ; \
	        for subtool in `cd lib/$$file/$$comp/$$tool; ls | grep -v .svn`; do \
		  if [ -d lib/$$file/$$comp/$$tool/$$subtool ]; then \
		     ./mkinstalldirs $(mx_libdir)/$$file/$$comp/$$tool/$$subtool ; \
	             for subsubtool in `cd lib/$$file/$$comp/$$tool/$$subtool; ls | grep -v .svn`; do \
                       $(INSTALL_DATA) lib/$$file/$$comp/$$tool/$$subtool/$$subsubtool $(mx_libdir)/$$file/$$comp/$$tool/$$subtool/$$subsubtool; \
                     done \
		  else \
                    $(INSTALL_DATA) lib/$$file/$$comp/$$tool/$$subtool $(mx_libdir)/$$file/$$comp/$$tool/$$subtool; \
		  fi; \
                done \
              else \
                $(INSTALL_DATA) lib/$$file/$$comp/$$tool $(mx_libdir)/$$file/$$comp/$$tool; \
	      fi; \
          done \
        else \
	        $(INSTALL_DATA) lib/$$file/$$comp $(mx_libdir)/$$file/$$comp; \
        fi; \
	    done \
	  else \
	    $(INSTALL_DATA) lib/$$file $(mx_libdir)/$$file; \
	  fi \
	done

mxinstalldirs:
	$(topdir)/mkinstalldirs $(bindir) $(libdir) $(mx_libdir) $(mandir)/man1

instrument.tab.o: mcstas.h
lex.yy.o: mcstas.h instrument.tab.h
debug.o: mcstas.h
memory.o: mcstas.h
symtab.o: mcstas.h
list.o: mcstas.h
coords.o: mcstas.h
cexp.o: mcstas.h
file.o: mcstas.h
cogen.o: mcstas.h
port.o: port.h
mcformat.o: mcstas.h

instrument.tab.c instrument.tab.h: instrument.y
	$(BISON) $(BISONFLAGS) instrument.y

lex.yy.c: instrument.l
	$(FLEX) $(FLEXFLAGS) instrument.l

# Prefer Scilab over Matlab over PGPLOT
config:
	if [ $(VRML) != no ]; then \
		$(MAKE) vrml; \
	fi; \
	if [ $(SCILAB) != no ]; then \
		$(MAKE) scilab; \
	fi; \
	if [ $(MATLAB) != no ]; then \
		$(MAKE) matlab; \
	fi; \
	if [ $(PGPLOT) != no ]; then \
		$(MAKE) pgplot; \
	fi;

scilab:
	sed "s/PLOTTER => '.*'./PLOTTER => 'Scilab'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
matlab:
	sed "s/PLOTTER => '.*'./PLOTTER => 'Matlab'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
pgplot:
	sed "s/PLOTTER => '.*'./PLOTTER => 'McStas'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
vrml:
	sed "s/PLOTTER => '.*'./PLOTTER => 'VRML'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
PGPLOT:
	$(MAKE) pgplot
Matlab:
	$(MAKE) matlab
Scilab:
	$(MAKE) scilab
VRML:
	$(MAKE) vrml
install-pgplot:
	cd support/pgplot && ./pgplot.sh && echo "McStas: run '$(MAKE) reconfigure'"

install-scilab:
	cd support/scilab && ./scilab.sh && echo "McStas: run './configure; $(MAKE); $(MAKE) install' again"

test:
	export PATH=${PWD}:$$PATH; export MCSTAS=${PWD}/lib; export PERL5LIB=${PWD}/lib/tools/perl; ./mcrun.fixpl --test

uninstall:
	cd $(bindir); rm -f $(BINOBJS)
	rm -rf $(mc_libdir)

reconfigure:
	cd $(mc_libdir)/tools/perl/
	$(mc_libdir)/tools/perl/mcstas_reconfigure

# Optional auto install of patched perl-Tk package
tk:
	if [ $(WGET) != no ]; then \
		$(WGET) http://www.mcstas.org/download/Tk-804.027_gtk2_patch.tar.gz &&\
		tar xzvf Tk-804.027_gtk2_patch.tar.gz > /dev/null && \
		cd Tk-804.027_gtk2_patch && $(PERL) Makefile.PL LIB=$(mc_libdir)/tools/perl/modules PREFIX=$(mc_libdir)/tools/perl/modules && $(MAKE) && $(MAKE) install ;\
	fi;
