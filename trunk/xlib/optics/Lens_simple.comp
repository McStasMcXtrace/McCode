/*******************************************************************************
*
* McXtrace, X-ray tracing package
*         Copyright 1997-2002, All rights reserved
*         Risoe National Laboratory, Roskilde, Denmark
*         Institut Laue Langevin, Grenoble, France
*
* Component: Lens_simple
*
* %I
* Written by: Erik Knudsen
* Date: June 16, 2009
* Version: $Revision: 1.0$
* Origin: Risoe
* Release: McXtrace 0.1
*
* Rectangular/circular slit
*
* %D
* Models an infinitely thin refractive lens, with focal_length f and 
* a numerical transmission of 0<T<=1
* the lens plane is in the X-Y plane at Z=0
*
* %P
* INPUT PARAMETERS
*
* xwidth: Width of lens. Overrides xmin,xmax. (m)
* yheight:Height of lens. Overrides ymin,ymax. (m)
* focal_length: Focal length of the lens. If >0 the lens is in focusing mode, <0 divergent (m)
*
* Optional parameters:
* T: Transmission efficieny of the lens. (1)
*
* %E
*******************************************************************************/
DEFINE COMPONENT Lens_simple
DEFINITION PARAMETERS ()
SETTING PARAMETERS (xwidth,yheight,T=1,focal_length) 

OUTPUT PARAMETERS ()
STATE PARAMETERS (x,y,z,kx,ky,kz,phi,Ex,Ey,Ez,p)

DECLARE
%{
  double xmax,xmin,ymax,ymin;
%}

INITIALIZE
%{
  if(!xwidth || !yheight){
    fprintf(stderr,"%s: Lens has zero area\n",NAME_CURRENT_COMP);
    exit(0);
  }
  xmax=xwidth/2.0;
  xmin=-xmax;
  ymax=yheight/2.0;
  ymin=-ymax;
%}

TRACE
%{
  double nx,ny,nz,rcnx,rcny,rcnz;  
  double sp,theta;

  PROP_Z0;
  if (x >xmin && x<xmax && y>ymin && y<ymax){
    SCATTER;
    if(T=0) 
      ABSORB;
    else
      p*=T;
    
    /*change direction towards focal pt.*/
    /*rotation is around the vector n given by k_xy and z-axis.*/
    vec_prod(nx,ny,nz,kx,ky,0,0,0,focal_length);
    NORM(nx,ny,nz);
    /*rotation angle is given by the x and y coordinates and the focal length*/
    theta=atan(sqrt(x*x+y*y)/fabs(focal_length));
    sp=scalar_prod(nx,ny,nz,kx,ky,kz);
    vec_prod(rcnx,rcny,rcnz,kx,ky,kz,nx,ny,nz);
    /*update k-vector using rotation formula*/
    kx= rcnx*cos(theta)+ sp*nx*(1-cos(theta)) + sin(theta)*rcnx;
    ky= rcny*cos(theta)+ sp*ny*(1-cos(theta)) + sin(theta)*rcny;
    kz= rcnz*cos(theta)+ sp*nz*(1-cos(theta)) + sin(theta)*rcnz;
  }
  else{
    ABSORB;
  }
%}

MCDISPLAY
%{
  magnify("xy");
  rectangle(0,0,0,xwidth,yheight,0);
%}

END
