# Makefile for @PACKAGE_NAME@.
#
#   This file is part of the @PACKAGE_NAME@ ray-trace simulation package
#   Copyright (C) 1997-2008, All rights reserved
#   Risoe National Laborartory, Roskilde, Denmark
#   Institut Laue Langevin, Grenoble, France
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; version 2 of the License.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# Available methods for installation
# make                 normal build
# make install         normal installation
# make clean           clean distro
# make test            distro self-test
# make plotter         best plotter choice
# make pgplot          plotter PGPLOT selection and perl-PGPLOT install
# make reconfigure     reconfigure @MCCODE@ installation (after software update)
# make install-pgplot  build and install PGPLOT
# make install-scilab  build and install Scilab
# make install-tk      build and install Tk

SHELL = /bin/sh

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
srcdir = @srcdir@
libdir = @libdir@
mandir = @mandir@
PWD = `pwd`


DEBUG = -DDEBUG=0
libdir_@MCCODE@ = $(libdir)/@MCCODE@

CC = @CC@
MINGW = @MINGW@
CFLAGS = @CFLAGS@
LDFLAGS= @LDFLAGS@

HAVE_QSORT = @HAVE_QSORT@
USE_NEXUS = @HAVE_NEXUS@

DEFS = @PACKAGE_NAME@ @DEFS@ $(DEBUG)
LIBS = @LIBS@

PERL = @PERL@

FLEX = flex
FLEXFLAGS=-i

BISON = bison
BISONFLAGS = -v -d

SCILAB = @SCILAB@
MATLAB = @MATLAB@
PGPLOT = @PGPLOT@
VRML = @VRMLVIEW@

WGET = @WGET@

XTERM = @TERM@

INSTALL=@INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@


#
# End of configuration section.
#

all: @MCCODE@

@MCCODE@: $(OBJECTS)
	cd src/ && $(MAKE)

clean:
	cd src/ && $(MAKE) clean
	rm -f src/config.cache src/Makefile config.cache Makefile

distclean:
	cd src/ && $(MAKE) distclean
	rm -f src/config.cache src/Makefile config.cache Makefile

install: 
	cd src/ && $(MAKE) install

# Prefer Scilab over Matlab over PGPLOT
config:
	if [ $(VRML) != no ]; then \
		$(MAKE) vrml; \
	fi; \
	if [ $(SCILAB) != no ]; then \
		$(MAKE) scilab; \
	fi; \
	if [ $(MATLAB) != no ]; then \
		$(MAKE) matlab; \
	fi; \
	if [ $(PGPLOT) != no ]; then \
		$(MAKE) pgplot; \
	fi;

scilab:
	sed "s/PLOTTER => '.*'./PLOTTER => 'Scilab'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
matlab:
	sed "s/PLOTTER => '.*'./PLOTTER => 'Matlab'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
pgplot:
	sed "s/PLOTTER => '.*'./PLOTTER => 'McStas'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
vrml:
	sed "s/PLOTTER => '.*'./PLOTTER => 'VRML'\,/" lib/tools/perl/mcstas_config.perl > lib/tools/perl/mcstas_config.perl.tmp
	mv lib/tools/perl/mcstas_config.perl.tmp lib/tools/perl/mcstas_config.perl
PGPLOT:
	$(MAKE) pgplot
Matlab:
	$(MAKE) matlab
Scilab:
	$(MAKE) scilab
VRML:
	$(MAKE) vrml

test:
	cd src && $(MAKE) test

uninstall:
	cd src && $(MAKE) uninstall

reconfigure:
	cd $(libdir_@MCCODE@)/tools/perl/
	$(libdir_@MCCODE@)/tools/perl/mcstas_reconfigure

# Optional auto install of patched perl-Tk, scilab and pgplot5 libs
install-pgplot:
	cd support/common && $(MAKE) install-pgplot
	make pgplot
	@echo "@PACKAGE_NAME@: run 'make reconfigure'"

install-scilab:
	cd suppor/common && make compile-scilab && echo "@PACKAGE_NAME@: run './configure; make; make install' again"

