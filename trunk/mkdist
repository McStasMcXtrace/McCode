#!/bin/sh
#
# Simple script for setting up a mcstas/mcxtrace distribution package.
#
# To be called with one/two input parameter(s) - distribution tail filename, e.g.
#
# ./mkdist version          -> ../mcstas-version.tar.gz
# ./mkdist version mcxtrace -> ../mcxtrace-version.tar.gz
#
# Assumes you have write access to ..
#
# PW, risoe, 20030123
#
#   This file is part of the McStas neutron ray-trace simulation package
#   Copyright (C) 1997-2006, All rights reserved
#   Risoe National Laborartory, Roskilde, Denmark
#   Institut Laue Langevin, Grenoble, France
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; version 2 of the License.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# define version and symbols that will be replaced in many places
if [ "y$2" = "ymcxtrace" ]; then
  PACKAGE_TARNAME=mcxtrace
  PACKAGE_NAME=McXtrace
else
  PACKAGE_TARNAME=mcstas
  PACKAGE_NAME=McStas
fi
PACKAGE_VERSION=$1
PACKAGE_STRING="$PACKAGE_NAME $PACKAGE_VERSION"
MONTH=`date +"%b"`
DAY=`date +"%d"`
YEAR=`date +"%Y"`
PACKAGE_DATE="'$MONTH'. '$DAY', '$YEAR'"

# Create temporary workdir:
PW=`pwd`
TMPDIR=$PWD/..
DIST=$TMPDIR/$PACKAGE_TARNAME-$PACKAGE_VERSION

# Copy current PW checkout to DIST
cp -rp $PW $DIST

# Create the doc's from tex - if a checkout is avail.
if [ -d $PW/../../McStasTeX/trunk ] ;
then
  cd $PW/../../McStasTeX/trunk
  ./build $PACKAGE_VERSION
  
  # copy the doc in DIST/doc. Only use PDF files in distro.
  mv $PACKAGE_TARNAME-$PACKAGE_VERSION-manual.pdf $DIST/doc/manuals/$PACKAGE_TARNAME-manual.pdf
  mv $PACKAGE_TARNAME-$PACKAGE_VERSION-components.pdf $DIST/doc/manuals/$PACKAGE_TARNAME-components.pdf
fi

# Go in DIST, clean up CVS/SVN information
cd $DIST
echo "Clean up SVN info"
find . -name .svn -exec rm -rf \{\} \; 2> /dev/null
# Make sure that all comps and instrs have unix linefeeds
echo "Apply dos2unix"
find . -name \*.comp  -exec dos2unix \{\} \;
find . -name \*.instr -exec dos2unix \{\} \;

# Put in new version info:
# MCCODE_VERSION="PACKAGE_NAME PACKAGE_VERSION - PACKAGE_DATE"
echo "Set version $PACKAGE_VERSION and date"
find . -wholename './setversion' -prune -o -type d -prune -o -path ./src/McStasTest -exec ./setversion \{\} $PACKAGE_VERSION \;
find . -wholename './setyear'    -prune -o -type d -prune -o -path ./src/McStasTest -exec ./setyear \{\} \;

# we update all package/version strings
echo "Set package $PACKAGE_VERSION information"
for file in src/mccode.h src/mcformat.c doc/man/*.1 support/deb/debcreate support/deb/control support/Win32/install/mcstas.nsi build.bat lib/share/mccode-r.h configure.in;
do
  sed 's/@MCCODE_VERSION@/'$PACKAGE_NAME'-'$PACKAGE_VERSION' - '$MONTH'. '$DAY', '$YEAR'/' $file > $file.tmp
  sed 's/@PACKAGE_DATE@/'$MONTH'. '$DAY', '$YEAR'/' $file.tmp > $file
  sed 's/@PACKAGE_TARNAME@/'$PACKAGE_TARNAME'/' $file > $file.tmp
  sed 's/@PACKAGE_NAME@/'$PACKAGE_NAME'/' $file.tmp > $file
  sed 's/@PACKAGE_VERSION@/'$PACKAGE_VERSION'/' $file > $file.tmp
  sed 's/@PACKAGE_STRING@/'$PACKAGE_NAME'-'$PACKAGE_VERSION'/' $file.tmp > $file
  sed 's/@PACKAGE_TARNAME@/'$PACKAGE_TARNAME'/' $file > $file.tmp
  mv $file.tmp $file
done
chmod a+x support/deb/debcreate

# Create the doc's from tex - if a checkout is avail.
cd $DIST
if [ -d $DIST/doc/install_docs/tex ] ;
then
  # Create ps/pdf/html based install info
  cd $DIST/doc/install_docs/tex
  latex install
  latex install
  whichdvipdf=`which dvipdf`
  if [ -e "$whichdvipdf" ] ;
  then
      echo "Generate install PDF files using dvipdf (better quality than ps2pdf)"
      dvipdf install.dvi install.pdf
  else
      echo "Generate install PDF files using ps2pdf"
      dvips -o install.ps install.dvi
      ps2pdf install.ps install.pdf
  # gzip install.ps
      rm *.ps *.ps.gz
  fi
  
  mkdir ../html
  latex2html -local_icons -dir ../html install.tex
  # clean up
  rm install.aux
  rm install.log
  cd $DIST/doc/tutorial
  # Update the tutorial files
  ./update
  rm update
  mkdir $DIST/lib/doc
  cp -r $DIST/doc/install_docs/ $DIST/lib/doc
  cp -r $DIST/doc/tutorial/ $DIST/lib/doc/
  cp -r $DIST/doc/man/ $DIST/lib/doc/
  cp  $DIST/doc/manuals/* $DIST/lib/doc/
fi  
cd $DIST

# Create configure
autoconf -o configure $CONFIGURE_IN
#chmod a+x configure
autoconf lib/tools/perl/mccode_reconfigure.in > lib/tools/perl/${PACKAGE_TARNAME}_reconfigure
mv lib/tools/perl/mccode_config.perl.in lib/tools/perl/${PACKAGE_TARNAME}_config.perl.in

# run lex, yacc (assuming linux - flex -i & bison -v -d)
cd src
flex -i instrument.l
bison -v -d instrument.y
cd ..

# Set the INSTALL environment variable to make the src archive
# default to ./install-sh in the contributed Makefile.
# Note: the -c is needed to preserve mcdoc.fixpl which is run at make install
export INSTALL="./install-sh -c"

# Also, do a ./configure to create Makefile and mccode_config.perl
# These will be dependent on this system, ofcourse...
./configure
# Select scilab as default plotter
make pgplot

# Clean up
rm TODO.txt
rm mkdist
rm setversion
rm setyear
rm header
# Make new runs of configure not dependent of this system...
rm config.*
cd ..

# Create tar archive
tar cfz $PW/../$PACKAGE_TARNAME-$PACKAGE_VERSION-src.tar.gz $PACKAGE_TARNAME-$PACKAGE_VERSION

# Do a 'make' for creation of binary version (should apply to 'any' Unix)
cd $PW
cd $DIST

# Default again to Linux' /usr/bin/install -c (or whatever ./configure finds)
export INSTALL=
./configure
# Select pgplot as default plotter
make pgplot

make
UNAME=`uname`
MACH=`uname -m`
# Up to now, this is always done on intel...
PROC=Intel
cd ..

# Create tar archive
tar cfz $PW/../$PACKAGE_TARNAME-$PACKAGE_VERSION-$MACH-$PROC-$UNAME.tar.gz $PACKAGE_TARNAME-$PACKAGE_VERSION

# Remove temporary dir
# rm -rf $TMPDIR

# Create .tar.gz archive for building a binary Windows version
cd $PW
cd $DIST
make clean
cd src
flex -i instrument.l
bison -v -d instrument.y
cd ..
./configure
sed 's/DOZIP="0"/DOZIP="1"/' build.bat > build.bat.new
sed 's/DONSIS="0"/DONSIS="1"/' build.bat.new > build.bat
cp support/Win32/install/which.exe .
cd ..
tar cfz $PW/../$PACKAGE_TARNAME-$PACKAGE_VERSION-Win32-src.tar.gz $PACKAGE_TARNAME-$PACKAGE_VERSION
if [ `which makensis` ]; then
    cd -
    ./configure
    # Make sure we default to PGPLOT plotter
    make pgplot
    make mcstas.win32
    cp mcstas.ini ..
    cp mcstas.nsi ..
    cp mcstas.bmp ..
    cp LICENSE.rtf ..
    cd ..
    zip -r $PACKAGE_TARNAME-$PACKAGE_VERSION-i686-Intel-Win32.zip $PACKAGE_TARNAME-$PACKAGE_VERSION
    cp winsupport/* .
    makensis mcstas.nsi
    echo Created Win32 binary packages: `ls *zip *exe`
else
    echo Binary versions for Win32 NOT created
fi
echo
echo
echo Your $PACKAGE_STRING dist packages are placed in
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-src.tar.gz
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-$MACH-$PROC-$UNAME.tar.gz
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-Win32-src.tar.gz
echo
echo NOTE: Win32 version must be built using \'build.bat\' of the Win32-src package
echo
echo Your $PACKAGE_STRING doc packages are placed in
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-manual.ps.gz
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-manual.pdf
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-components.ps.gz
echo ../$PACKAGE_TARNAME-$PACKAGE_VERSION-components.pdf
echo
echo WARNING: Please install to a test system and run the following tools
echo before release:
echo
echo compiletest.sh \(check if all examples compile\)
echo mcrun --test \(validation test of selected instruments\)
echo
echo Follow instructions in ../adm to publish on the web.
echo

echo Build packages from `pwd`
# In case of mkfs.hfsplus available in /sbin we'll create the
# DMG file for Mac OS X
if [ -e /sbin/mkfs.hfsplus ]
then
    # Note: DMG file needs enough space to hold the support tools plus
    # our own code. April 2008 this is about 120 megs...
    dd if=/dev/zero of=./$PACKAGE_TARNAME-$PACKAGE_VERSION.dmg bs=1M count=130
    /sbin/mkfs.hfsplus -v $PACKAGE_NAME ./$PACKAGE_TARNAME-$PACKAGE_VERSION.dmg
    # Likely needs root level access:
    sudo mkdir /mnt/dmg
    sudo mount -t hfsplus -o loop ./$PACKAGE_TARNAME-$PACKAGE_VERSION.dmg /mnt/dmg
    # Copy the ./adm/OSX/DMG stuff to the mountpoint
    sudo cp -rp ./adm/OSX/DMG/Applications /mnt/dmg
    sudo cp ./adm/OSX/DMG/README.TXT /mnt/dmg
    # Clear out CVS stuff
    sudo find /mnt/dmg -type d -name CVS -exec rm -rf \{\} \;
    # Copy McStas there
    sudo cp ./$PACKAGE_TARNAME-$$PACKAGE_VERSION-src.tar.gz /mnt/dmg/Applications
    # Unmount
    sudo umount /mnt/dmg
    sudo rm -rf /mnt/dmg
    ls -l ./$PACKAGE_TARNAME-$$PACKAGE_VERSION.dmg
fi


# In case of a debian build host, we also build an .deb
# (.rpm was tried using alien - did not work too well)
if [ -e /etc/debian_version ]
then
  if [ -e etch-chroot ]
  then
    echo Proceeding to .deb build
    # First, clean up in case of previous McStas installs in the chrooot
    sudo mkdir -p etch-chroot/build
    sudo rm -f etch-chroot/usr/local/bin/*
    sudo rm -rf etch-chroot/usr/local/lib/*
    sudo rm -rf etch-chroot/usr/local/pgplot
    sudo cp $PACKAGE_TARNAME-$$PACKAGE_VERSION/deb/debcreate etch-chroot/root
    sudo cp $PACKAGE_TARNAME-$$PACKAGE_VERSION-src.tar.gz etch-chroot/root
    sudo chroot etch-chroot /root/debcreate
    echo
    echo
    echo Build packages created:
    echo
    cp etch-chroot/build/*deb .
    ls -lf $PACKAGE_TARNAME-$$PACKAGE_VERSION*.*
    echo
  else
    echo You need a chroot environment based on debootstrap in etch-chroot before building deb packages
  fi
fi
